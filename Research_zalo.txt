- Vá»›i web thÃ¬ dÃ² websocket -> hÃ m open websocket -> ra listener message -> dÃ² ra _onRawData -> _onData Ä‘á»ƒ xá»­ lÃ½ message sau khi Ä‘Ã£ decrypt vÃ  hÃ m decrypt -> Ä‘Æ°a vÃ o chatgpt Ä‘á»ƒ generate ra code decrypt vá»›i key Ä‘Æ°á»£c táº¡o ra á»Ÿ má»—i session

- Vá»›i zalo window app thÃ¬ nÃ³ Ä‘ang Ä‘Æ°á»£c build báº±ng electron -> web-based app -> unpackaged ra Ä‘áº·t tÃªn folder lÃ  app, move app.asar qua chá»— khÃ¡c, táº¡o 1 file app.asar khÃ¡c vá»›i ná»™i dung lÃ  :echo "{}" -> Ä‘á»ƒ nÃ³ fallback vá» folder app (do trong logic cá»§a Zalo.exe sáº½ check xem app.asar cÃ³ hay khÃ´ng) -> sau Ä‘Ã³ xÃ i JS-Beautify for VS Code extension (áº¥n F1 -> beautify) Ä‘á»ƒ generate ra code dá»… Ä‘á»c hÆ¡n

- Flow tÃ¬m thÃ¬ tá»« viá»‡c open WebSocket -> dÃ² ra cÃ¡c listener liÃªn quan -> dÃ² ra hÃ m sá»­ dá»¥ng Ä‘á»ƒ decrypt

- HÃ m xá»­ lÃ½ undo trong database vÃ  tin nháº¯n má»›i nháº­n tá»›i

- beautify báº±ng js-beautify : Get-ChildItem .\ -Recurse -Filter *.js | ForEach-Object { js-beautify $_.FullName -r }

- replace báº±ng git grep: git grep -l 'devTools: !1' | xargs sed -i 's/devTools: !1/devTools: true/g'

- debug UI electron: Zalo.exe --remote-debugging-port=9222
- debug main.js electron : Zalo.exe --inspect=9229
-> Zalo.exe --inspect=9229 --remote-debugging-port=9222
edge://inspect/#devices
chrome://inspect/#devices

- Ä‘em console.log vá»:
	const iframe = document.createElement('iframe');
	iframe.style.display = 'none';
	document.body.appendChild(iframe);

	// GÃ¡n láº¡i console.log tá»« iframe
	console.log = iframe.contentWindow.console.log.bind(window);

- string to json: JSON.parse()

- HÃ m IIFE search full path tá»›i `this` (táº¡o scope riÃªng): (nháº­p vÃ o console)
	(() => {
		const target = this._onData;

		const deepTrace = (obj, path = "window", visited = new WeakSet()) => {
			if (visited.has(obj)) return;
			visited.add(obj);

			for (let key in obj) {
				try {
					const val = obj[key];
					const fullPath = `${path}.${key}`;
					if (val === target) {
						console.log("ğŸ” Found at", fullPath);
					} else if (typeof val === "object" && val !== null) {
						deepTrace(val, fullPath, visited);
					}
				} catch (e) {}
			}
		};

		deepTrace(window);
	})();

- Vá»›i zalo pc thÃ¬ patch nhÆ° nÃ y:
	default-login-main-startup-shared-worker-znotification.b65af72f3439d0f838c9.js:
	async _onData(e, t, n, a) {
		let tmp = JSON.parse(a);
		if (tmp?.data?.msgs?.[0]?.msgType === "chat.undo") {
			tmp.data.msgs[0].msgType = "chat.undo_fake";
			a = JSON.stringify(tmp);
		}
		const s = this._getDataHanlder(e, t);
		if (!s) return void this._submitSentry("unsupported cmd " + e);
		let i = null;
		try {
			i = s.preParseData(a)
		} catch (o) {
			return this._submitSentry("error on parsing data " + o), void this._onDataError(_.c.CANNOT_PARSE)
		}
		0 === i.error_code ? s.onData(e, t, i) : this._onDataError(i.error_code)
	}

Tampermonkey script:
https://github.com/Tampermonkey/tampermonkey/issues/2384
	- Send to telegram:
		// ==UserScript==
		// @name         Zalo to Telegram
		// @namespace    http://tampermonkey.net/
		// @version      1.0
		// @description  Gá»­i tin nháº¯n tá»« Zalo sang Telegram
		// @match        https://chat.zalo.me/*
		// @grant        GM_xmlhttpRequest
		// @grant        unsafeWindow
		// @connect      api.telegram.org
		// @sandbox     JavaScript
		// ==/UserScript==

		(function() {
			'use strict';

			const BOT_TOKEN = "";
			const CHAT_ID = "";

			window.addEventListener("message", function(event) {
				if (event.data?.type === "ZALO_DATA") {
					const a = event.data.payload;
					const content = a?.data?.msgs?.[0]?.content || "[KhÃ´ng cÃ³ ná»™i dung]";
					const sender = a?.data?.msgs?.[0]?.dName || "Unknown";

					const text = `ğŸ’¬ Tin nháº¯n tá»« ${sender}:\n${content}`;

					GM_xmlhttpRequest({
						method: "POST",
						url: `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
						headers: {
							"Content-Type": "application/x-www-form-urlencoded"
						},
						data: `chat_id=${CHAT_ID}&text=${encodeURIComponent(text)}`,
						onload: function(response) {
							console.log("âœ… Gá»­i Telegram:", response.responseText);
						},
						onerror: function(err) {
							console.error("âŒ Lá»—i gá»­i:", err);
						}
					});

				}
			});
		})();

	- Patch chat.zalo.me cháº·n undo vÃ  gá»Ÿi message tá»›i tele:
		// ==UserScript==
		// @name         New 2
		// @namespace    http://tampermonkey.net/
		// @version      2025-09-12
		// @description  try to take over the world!
		// @author       You
		// @match        https://chat.zalo.me/*
		// @run-at       document-start
		// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
		// @grant        none
		// ==/UserScript==

		(function() {
			'use strict';

			// KhÃ´i phá»¥c console.log gá»‘c Ä‘á»ƒ trÃ¡nh bá»‹ web override
			const iframe = document.createElement('iframe');
			document.body.appendChild(iframe);
			console.log = iframe.contentWindow.console.log.bind(window.console);


			function restoreConsole() {
				const iframe = document.createElement('iframe');
				document.body.appendChild(iframe);
				console.log = iframe.contentWindow.console.log.bind(window.console);
			}

			function hookSocket(socketObj) {
				if (!socketObj || typeof socketObj._onData !== 'function') return;
				console.log("ğŸ¯ Hooking _onData on", socketObj);

				const orig = socketObj._onData;
				socketObj._onData = function(e, t, n, a) {
					console.log("a =", a);
					try {
						let parsed = a;
						let isString = false;

						if (typeof a === "string") {
							parsed = JSON.parse(a);
							isString = true;
						}
						//if (typeof a === "string") parsed = JSON.parse(a);

						if (
							parsed?.data?.msgs &&
							parsed.data.msgs.some(msg => msg.msgType === "chat.undo")
						) {
							console.log("â© Bá» qua xá»­ lÃ½ vÃ¬ msgType = chat.undo");
							parsed.data.msgs[0].msgType = "chat.undo_fake";

							// Gá»­i ná»™i dung ra ngoÃ i qua postMessage
							window.postMessage({
								type: "ZALO_DATA",
								payload: parsed
							}, "*");

							// Náº¿u ban Ä‘áº§u lÃ  string â†’ stringify láº¡i Ä‘á»ƒ thay tháº¿ trong a
							if (isString) {
								a = JSON.stringify(parsed);
							} else {
								a = parsed;
							}

							return orig.apply(this, [e, t, n, a]); // KhÃ´ng gá»i hÃ m gá»‘c
						}
					} catch (err) {
						console.warn("Lá»—i khi check a:", err);
					}
					return orig.apply(this, [e, t, n, a]);
				};
			}

			// Äá»£i tá»›i khi object xuáº¥t hiá»‡n rá»“i hook
			function waitForSocket() {
				const target = window.$$afmc?.socketPolling?._chatHandler?._socket;
				if (target && typeof target._onData === 'function') {
					hookSocket(target);
				} else {
					setTimeout(waitForSocket, 50);
				}
			}

			waitForSocket();



		})();

- PhÆ°Æ¡ng phÃ¡p mÃ  zalo decrypt key:
	from base64 import b64decode
	from Crypto.Cipher import AES
	import gzip
	from io import BytesIO

	def b64_to_bytes(s: str) -> bytes:
		"""Chuyá»ƒn Ä‘á»•i chuá»—i Base64 sang bytes."""
		return b64decode(s)

	def decrypt_aes_128_gcm(base64_data: str, key: bytes) -> bytes:
		"""Giáº£i mÃ£ dá»¯ liá»‡u báº±ng AES-128-GCM."""
		raw = b64_to_bytes(base64_data)
		iv = raw[:16]
		aad = raw[16:32]
		ciphertext = raw[32:-16]
		tag = raw[-16:]

		cipher = AES.new(key, AES.MODE_GCM, nonce=iv)
		cipher.update(aad)
		plaintext = cipher.decrypt_and_verify(ciphertext, tag)
		return plaintext

	def decrypt_and_decompress(enc_base64: str, key_base64: str) -> str:
		"""Giáº£i mÃ£ vÃ  giáº£i nÃ©n dá»¯ liá»‡u tá»« Zalo WebSocket."""
		try:
			key = b64_to_bytes(key_base64)
			decrypted_bytes = decrypt_aes_128_gcm(enc_base64, key)
			with gzip.GzipFile(fileobj=BytesIO(decrypted_bytes)) as f:
				decompressed = f.read()
			return decompressed.decode('utf-8')
		except Exception as e:
			return f"âŒ Decrypt failed: {e}"

	# === VÃ­ dá»¥ sá»­ dá»¥ng ===
	if __name__ == "__main__":
		key_base64 = 's5UdtUr2zLeLFPEe5IKUHw=='
		enc_base64 = 'FPRBtuqciMaFEm7DQ2dGq1uMugkqNe6B60zYc98ZFb/6YzLvOTeJFxldbKKtkUtmQuKYZ4hS1r0fxmaw1riS8Z8ZwAx/c3G1lRY/YPc5r0tlpsGUyNIPgoLT6Ecl2yWg5506zX1Dmhmn67Uj5BqlUubjDnN9WdtoAnlwt3RGGeV7btBWhkKTgkkzzbJgbrdu58eGJlBJregkNpPA8238/4jTJhYvLZLLKK99VoCrkkQT36doPyWGUKt18XWoVPanDBuSCkVW7/09c7wILpvVYDCIfhnJHBN4i/v8zQGhOnqCyNYk1amfEVA52+N3WSEPojtp/nObep4='

		result = decrypt_and_decompress(enc_base64, key_base64)
		print("âœ… Final content:", result)

- káº¿t há»£p vá»›i mitm Ä‘á»ƒ xem log realtime:
	from mitmproxy import ctx, http
	from base64 import b64decode
	from Crypto.Cipher import AES
	import gzip
	from io import BytesIO
	import json

	# Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u trá»¯ key giáº£i mÃ£
	_cipher_key = None

	def websocket_message(flow: http.HTTPFlow):
		# Chá»‰ xá»­ lÃ½ náº¿u flow nÃ y lÃ  WebSocket
		if flow.websocket is None:
			return

		# Láº¥y tin nháº¯n cuá»‘i cÃ¹ng
		msg = flow.websocket.messages[-1]
		direction = "Client â†’ Server" if msg.from_client else "Server â†’ Client"

		try:
			# Thá»­ decode tin nháº¯n thÃ nh vÄƒn báº£n
			text = msg.content.decode("utf-8", errors="replace")
			
			# Convert to json
			json_start = msg.content.find(b'{')
			json_bytes = msg.content[json_start:]
			json_str = json_bytes.decode('utf-8')
			data = json.loads(json_str)

			global _cipher_key

			# Cáº­p nháº­t key náº¿u cÃ³
			if "key" in data:
				_cipher_key = data["key"]
				ctx.log.info(f"[WS] Key updated: {data['key']}")

			# Náº¿u cÃ³ dá»¯ liá»‡u mÃ£ hÃ³a, tiáº¿n hÃ nh giáº£i mÃ£ vÃ  giáº£i nÃ©n
			if "data" in data and _cipher_key:
				encrypted_data = data["data"]
				try:
					decrypted_content = decrypt_and_decompress(encrypted_data, _cipher_key)
					ctx.log.info(f"[WS] {direction} | Decrypted Data: {decrypted_content}")
				except Exception as e:
					ctx.log.error(f"[WS] {direction} | Decrypt failed: {e}")
					
		except json.JSONDecodeError:
			# Náº¿u khÃ´ng pháº£i JSON, in ra ná»™i dung thÃ´
			ctx.log.info("=====DEBUG-NOTHING=====")
			# Thá»­ decode tin nháº¯n thÃ nh vÄƒn báº£n
			text = msg.content.decode("utf-8", errors="replace")
			json_start = msg.content.find(b'{')
			json_bytes = msg.content[json_start:]
			json_str = json_bytes.decode('utf-8')
			data = json.loads(json_str)
			# Thá»­ parse JSON
			#data = json.loads(text)
			ctx.log.info("v=====DEBUG=====")
			ctx.log.info(f"Received message content: {repr(data)}")
			ctx.log.info("^=====DEBUG=====")
			#ctx.log.info(f"[DEBUG] {direction}: {repr(msg.content.data)}")
			ctx.log.info(f"[WS] {direction}: {repr(msg.content)}")
		except Exception as e:
			ctx.log.error(f"[WS] {direction} | Unexpected error: {e}")

	def b64_to_bytes(s: str) -> bytes:
		"""Chuyá»ƒn Ä‘á»•i chuá»—i Base64 sang bytes."""
		return b64decode(s)

	def decrypt_aes_128_gcm(base64_data: str, key: bytes) -> bytes:
		"""Giáº£i mÃ£ dá»¯ liá»‡u báº±ng AES-128-GCM."""
		raw = b64_to_bytes(base64_data)
		iv = raw[:16]
		aad = raw[16:32]
		ciphertext = raw[32:-16]
		tag = raw[-16:]

		cipher = AES.new(key, AES.MODE_GCM, nonce=iv)
		cipher.update(aad)
		plaintext = cipher.decrypt_and_verify(ciphertext, tag)
		return plaintext

	def decrypt_and_decompress(enc_base64: str, key_base64: str) -> str:
		"""Giáº£i mÃ£ vÃ  giáº£i nÃ©n dá»¯ liá»‡u tá»« Zalo WebSocket."""
		try:
			key = b64_to_bytes(key_base64)
			decrypted_bytes = decrypt_aes_128_gcm(enc_base64, key)
			with gzip.GzipFile(fileobj=BytesIO(decrypted_bytes)) as f:
				decompressed = f.read()
			return decompressed.decode('utf-8')
		except Exception as e:
			return f"âŒ Decrypt failed: {e}"

- Zapy vÃ´ tri má»›i (xáº¥u): C:\Users\Admin\AppData\Roaming\ZaloData\media\2131430020829351610\sticker\61900
  Zapy vÃ´ tri cÅ©:  C:\Users\Admin\AppData\Roaming\ZaloData\media\2131430020829351610\sticker\12292
	ChÃ©p Ä‘Ã¨ sticker cÅ© qua má»›i (useless):
	$src  = "C:\Users\Admin\AppData\Roaming\ZaloData\media\2131430020829351610\sticker\12292"
	$dest = "C:\Users\Admin\AppData\Roaming\ZaloData\media\2131430020829351610\sticker\61900"

	$srcDirs  = Get-ChildItem -Path $src  -Directory | Sort-Object Name
	$destDirs = Get-ChildItem -Path $dest -Directory | Sort-Object Name

	for ($i = 0; $i -lt $srcDirs.Count; $i++) {
		$s = $srcDirs[$i].FullName
		$d = $destDirs[$i].FullName

		# Láº¥y file duy nháº¥t trong dest
		$destFile = Get-ChildItem -Path $d -File | Select-Object -First 1
		if ($null -eq $destFile) {
			Write-Host "KhÃ´ng tÃ¬m tháº¥y file trong $d, bá» qua..."
			continue
		}

		$targetPath = $destFile.FullName

		Write-Host "Copy tá»« $s -> $targetPath"

		# Copy táº¥t cáº£ file trong src, ghi Ä‘Ã¨ lÃªn file Ä‘Ã­ch
		Get-ChildItem -Path $s -File | ForEach-Object {
			Copy-Item -Path $_.FullName -Destination $targetPath -Force
		}
	}


- ChÃ©p vÃ  convert sticker qua telegram:
# 1. Äá»‹nh nghÄ©a cÃ¡c biáº¿n cáº§n thiáº¿t
# Thay tháº¿ Ä‘Æ°á»ng dáº«n nÃ y báº±ng thÆ° má»¥c gá»‘c chá»©a cÃ¡c folder sticker nhá»
$zaloStickerPath = "C:\Users\Admin\AppData\Roaming\ZaloData\media\2131430020829351610\sticker\61900" 

# ThÆ° má»¥c Ä‘Ã­ch Ä‘á»ƒ lÆ°u cÃ¡c file PNG Ä‘Ã£ resize (thÆ° má»¥c hiá»‡n táº¡i)
$outputPath = ".\Sticker_Output" 

# Äáº£m báº£o thÆ° má»¥c output tá»“n táº¡i
if (-not (Test-Path $outputPath)) {
    New-Item -Path $outputPath -ItemType Directory | Out-Null
}

# 2. TÃ¬m kiáº¿m Ä‘á»‡ quy táº¥t cáº£ file PNG vÃ  Resize báº±ng FFmpeg
Get-ChildItem -Path $zaloStickerPath -Recurse -File -Filter "*.png" | ForEach-Object {
    
    # Láº¥y tÃªn file gá»‘c (vÃ­ dá»¥: b6ccb1b464756cf227ccad8aa02b53d6.png)
    $fileName = $_.Name
    
    # Táº¡o Ä‘Æ°á»ng dáº«n file Ä‘áº§u ra hoÃ n chá»‰nh
    $outputFile = Join-Path -Path $outputPath -ChildPath $fileName
    
    # Lá»‡nh FFmpeg Ä‘á»ƒ Resize
    # scale=512:512 Ã©p kÃ­ch thÆ°á»›c thÃ nh 512x512
    # -y lÃ  ghi Ä‘Ã¨ náº¿u file Ä‘Ã£ tá»“n táº¡i
    
    Write-Host "Äang xá»­ lÃ½: $($_.FullName)"
    
    ffmpeg -i "$($_.FullName)" -vf scale=512:512 -y "$outputFile"
    
    Write-Host "  -> ÄÃ£ lÆ°u vÃ o: $outputFile"
}

Write-Host "---"
Write-Host "HoÃ n thÃ nh. Táº¥t cáº£ cÃ¡c file PNG Ä‘Ã£ Ä‘Æ°á»£c resize vá» 512x512 vÃ  lÆ°u trong thÆ° má»¥c: $outputPath"

https://ezgif.com/webp-to-webm : convert qua webm cho animated sticker
https://products.aspose.app/video/change-speed/webm : tÄƒng speed Ä‘Ã¡p á»©ng < 3s